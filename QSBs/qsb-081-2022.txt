
             ---===[ Qubes Security Bulletin 081 ]===---

                             2022-06-16

            x86: MMIO Stale Data vulnerabilities (XSA-404)


User action required
---------------------

Users with appropriate hardware (see the "affected hardware" section
below) must install the following specific packages in order to address
the issues discussed in this bulletin:

  For Qubes 4.0, in dom0:
  - Xen packages, version 4.8.5-41

  For Qubes 4.1, in dom0:
  - Xen packages, version 4.14.5-3

These packages will migrate from the security-testing repository to the
current (stable) repository over the next two weeks after being tested
by the community. [1] Once available, the packages are to be installed
via the Qubes Update tool or its command-line equivalents. [2]

Dom0 must be restarted afterward in order for the updates to take
effect.

If you use Anti Evil Maid, you will need to reseal your secret
passphrase to new PCR values, as PCR18+19 will change due to the new
Xen binaries.


Summary
--------

On 2022-06-14, the Xen Project published XSA-404, "x86: MMIO Stale
Data vulnerabilities" [3]:

| This issue is related to the SRBDS, TAA and MDS vulnerabilities.
| Please see:
| 
|   https://xenbits.xen.org/xsa/advisory-320.html (SRBDS)
|   https://xenbits.xen.org/xsa/advisory-305.html (TAA)
|   https://xenbits.xen.org/xsa/advisory-297.html (MDS)
| 
| Please see Intel's whitepaper:
| 
|   https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/processor-mmio-stale-data-vulnerabilities.html

A VM with an assigned PCI device can use speculative execution to infer
the memory content of other guests or Xen itself. In the default Qubes
OS configuration, only sys-net and sys-usb can perform this attack. The
specific impact and possible mitigations depend on the device's CPU and
installed microcode.


Affected hardware
------------------

Unfortunately, all Intel systems are affected. Mitigations are available
only to a subset of Intel CPUs, namely those that were eligible for the
Intel microcode update released in May 2022. See the
"microcode-20220510" section of Intel's release notes [4] for the
complete list. (Since this list may be difficult for end users to
interpret, we will also work to provide more detailed end-user
instructions for determining whether a given CPU is affected.) If your
device's CPU is in this list, then installing the Xen packages listed in
the "user action required" section above will apply the aforementioned
mitigations (assuming you already have installed the microcode update in
the past).

Regrettably, all Intel CPU models that do *not* appear on the
aforementioned list remain vulnerable, and there is *no* known
mitigation available for them. If your system has one of these CPUs,
then installing The Xen packages listed in the "user action required"
section above is *not* expected to mitigate the problem described in
this bulletin. Nonetheless, we still recommend installing the updates
anyway (once available), since they will not make the problem any worse,
and future updates will be based on the latest version.

For CPU models without available mitigations you need to assume that a
competent attacker that gains code execution on a VM with assigned PCI
devices (typically sys-usb and sys-net) can read information that should
only be accessible to Xen or another VM (and potentially use that
information for further attacks). So unfortunately those VMs need to be
treated as (more) trusted.

Please note the official table of affected CPUs at [5] is not fully
accurate at the time of writing this advisory.

Further plans regarding PCI passthrough
----------------------------------------

This is yet another issue affecting only VMs with access to PCI devices.
As a defensive measure, we will be changing how we handle such VMs in
future Qubes OS releases. Specifically, they will be treated as more
privileged VMs that require additional protection. Specific protective
measures will be discussed with the community following the publication
of this bulletin. Design and implementation of those measures will take
time and if they are more invasive will be probably restricted to
further releases.


Credits
--------

See the original Xen Security Advisory.


References
-----------

[1] https://www.qubes-os.org/doc/testing/
[2] https://www.qubes-os.org/doc/how-to-update/
[3] https://xenbits.xen.org/xsa/advisory-404.html
[4] https://github.com/intel/Intel-Linux-Processor-Microcode-Data-Files/blob/main/releasenote.md#microcode-20220510
[5] https://www.intel.com/content/www/us/en/developer/topic-technology/software-security-guidance/processors-affected-consolidated-product-cpu-model.html

--
The Qubes Security Team
https://www.qubes-os.org/security/
