
             ---===[ Qubes Security Bulletin 081 ]===---

                             2022-06-16

            x86: MMIO Stale Data vulnerabilities (XSA-404)


User action required
---------------------

Users with appropriate hardware (see the "affected hardware" section
below) must install the following specific packages in order to address
the issues discussed in this bulletin:

  For Qubes 4.0, in dom0:
  - Xen packages, version 4.8.5-41

  For Qubes 4.1, in dom0:
  - Xen packages, version 4.14.5-3

These packages will migrate from the security-testing repository to the
current (stable) repository over the next two weeks after being tested
by the community. [1] Once available, the packages are to be installed
via the Qubes Update tool or its command-line equivalents. [2]

Dom0 must be restarted afterward in order for the updates to take
effect.

If you use Anti Evil Maid, you will need to reseal your secret
passphrase to new PCR values, as PCR18+19 will change due to the new
Xen binaries.


Summary
--------

On 2022-06-14, the Xen Project published XSA-404, "x86: MMIO Stale
Data vulnerabilities" [3]:

| This issue is related to the SRBDS, TAA and MDS vulnerabilities.
| Please see:
| 
|   https://xenbits.xen.org/xsa/advisory-320.html (SRBDS)
|   https://xenbits.xen.org/xsa/advisory-305.html (TAA)
|   https://xenbits.xen.org/xsa/advisory-297.html (MDS)
| 
| Please see Intel's whitepaper:
| 
|   https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/processor-mmio-stale-data-vulnerabilities.html

A VM with an assigned PCI device can use speculative execution to infer
the memory content of other guests or Xen itself. In the default Qubes
OS configuration, only sys-net and sys-usb can perform this attack. The
specific impact and possible mitigations depend on the device's CPU and
installed microcode.


Affected hardware
------------------

All Intel systems are affected. While mitigations are available, they
are available only for some Intel CPU models. Normally, it should be a
simple matter to look up a given CPU model number in a table to see
whether it is affected and whether it is eligible for any mitigations.
Indeed, Intel has published a table [4] that claims to serve this
purpose. Unfortunately, however, we have found several inaccuracies in
this table. Since we cannot rely on the table, we have had to devise an
alternative method using other published Intel technical documents that
appear to be more accurate. This has turned out to be quite confusing
and difficult. We present the alternative method below, but be warned
that it is quite complex and is likely to prove challenging for all but
the most tech-savvy users.

Our best evidence indicates that mitigations are available for all and
only those CPUs that are both eligible for and updated with the Intel
microcode update released in May 2022. First, have a look at the
"microcode-20220510" section of Intel's release notes [5] for the
complete list of CPU models. Note that Intel uses three different naming
schemes for their CPUs, so the retail model numbers with which we are
most familiar do not appear on this table. Instead, compare the
numerical values in the "F-M-S/PI" column against `/proc/cpuinfo` or
`lscpu`. "F-M-S/PI" stands for "Family-Model-Stepping/Platform ID," the
last of which (PI) can be ignored. Note that `/proc/cpuinfo` presents
the values in decimal, while the table presents them in hexadecimal, so
conversion is required. This is all described in further detail in
Intel's README [6].

Now, if your device's CPU is in this list and has the required
microcode-20220510 update, then installing the Xen packages listed in
the "user action required" section of this QSB will apply the
aforementioned mitigations. To check whether your CPU has the required
microcode update, you can compare the "microcode" field of
`/proc/cpuinfo` against the aforementioned list. Alternatively, you can
check whether you have `microcode_ctl-2.1-35.qubes1` installed, but keep
in mind that this alone can't tell you whether the update actually
applies to your CPU.

Unfortunately, all Intel CPU models that do *not* appear on the
aforementioned list remain vulnerable, and there is *no* known
mitigation available for them. If your system has one of these CPUs,
then installing The Xen packages listed in the "user action required"
section above is *not* expected to mitigate the problem described in
this bulletin. There is simply nothing we can do for these CPUs (in
terms of patching) unless or until we receive a fix from Intel or Xen
(or confirmation that the current fix actually does benefit them after
all). Nonetheless, we still recommend installing the updates anyway
(once available), since they will not make the problem any worse, and
there is a chance that they could help (e.g., if the mitigation
eligibility criteria turn out to be overly conservative). Moreover,
keeping up-to-date with all security updates is a general best practice,
and future updates will be based on the latest version.

However, hope is not entirely lost for users whose CPUs are not eligible
for software mitigations. Since the vulnerability discussed in this
bulletin does not affect VMs without PCI passthrough devices, users
still have the option of altering their habits to treat VMs like sys-usb
and sys-net as more trusted. (Essentially, we must assume that an
adversary with the ability to execute arbitrary code in a VM with an
assigned PCI device can read information that should be accessible only
to Xen or another VM and may use that information to launch further
attacks.) While this can be especially challenging in the case of
sys-net, it at least affords users *some* latitude in working around the
problem by being mindful of when such VMs are running, how trusted their
templates are, and similar considerations.


Further plans regarding PCI passthrough
----------------------------------------

This is yet another issue affecting only VMs with access to PCI devices.
This pattern of vulnerabilities has prompted us to research more secure
ways of handling such VMs in future Qubes releases. Eventually, we plan
to treat them as more privileged VMs that require additional protection.
Specific protective measures will be discussed with the community as
part of our ongoing research and development efforts.


Credits
--------

See the original Xen Security Advisory.


References
-----------

[1] https://www.qubes-os.org/doc/testing/
[2] https://www.qubes-os.org/doc/how-to-update/
[3] https://xenbits.xen.org/xsa/advisory-404.html
[4] https://www.intel.com/content/www/us/en/developer/topic-technology/software-security-guidance/processors-affected-consolidated-product-cpu-model.html
[5] https://github.com/intel/Intel-Linux-Processor-Microcode-Data-Files/blob/main/releasenote.md#microcode-20220510
[6] https://github.com/intel/Intel-Linux-Processor-Microcode-Data-Files#about-processor-signature-family-model-stepping-and-platform-id


--
The Qubes Security Team
https://www.qubes-os.org/security/
